<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Admin | Travel Map App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ‚ö†Ô∏è Google Maps API ‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠ -->
    <style>
        :root {
            --admin-color: #059669; /* Green */
            --admin-dark: #047857;
            --update-color: #f59e0b; /* Amber */
        }
        body { font-family: 'Inter', sans-serif; background-color: #e5e7eb; }
        .btn-admin {
            background-color: var(--admin-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }
        .btn-admin:hover { background-color: var(--admin-dark); }
        .btn-update {
            background-color: var(--update-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }
        .btn-update:hover { background-color: #d97706; }
        .input-field {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            border-radius: 0.5rem;
            width: 100%;
            box-sizing: border-box;
        }
        .card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .login-box {
            max-width: 400px;
            margin: auto;
            margin-top: 10vh;
        }
    </style>
</head>
<body class="min-h-screen">

    <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
        <div class="text-2xl font-bold text-admin-color">üõ†Ô∏è Admin Panel</div>
        <div class="flex items-center space-x-4">
            <a href="index.html" class="text-gray-600 hover:text-admin-dark transition-colors">‚Üê ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
            <div id="user-info" class="text-sm text-admin-dark bg-green-100 p-2 rounded-full">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 hidden lg:block">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</h1>

        <!-- Login Form (Visible if not logged in) -->
        <div id="login-section" class="login-box card hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <form id="login-form">
                <div class="space-y-4">
                    <input type="email" id="admin-email" class="input-field" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô" required>
                    <input type="password" id="admin-password" class="input-field" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                    <button type="submit" class="btn-admin w-full" id="login-btn">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                    <div id="login-message" class="text-red-500 text-sm mt-3 hidden"></div>
                </div>
            </form>
        </div>


        <!-- Admin Content (Visible if logged in) -->
        <div id="admin-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6 hidden">

            <!-- Column 1: Add/Edit Location Form -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Add/Edit Location Form -->
                <div class="card border border-admin-color">
                    <h2 class="text-xl font-semibold text-admin-color mb-4" id="form-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà</h2>
                    
                    <form id="add-location-form" onsubmit="saveAttraction(event)">
                        <div class="space-y-3">
                            
                            <!-- Instruction/Link for Coordinates (UPDATED) -->
                            <p class="text-sm text-gray-600 pt-1">
                                üîó ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô 
                                <a href="https://www.google.com/maps" target="_blank" class="text-sm text-blue-500 hover:text-blue-700 font-medium underline">Google Maps</a> 
                                ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å **‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ä‡∏£‡πå** ‡∏°‡∏≤‡∏ß‡∏≤‡∏á
                            </p>

                            <input type="text" id="location-name" class="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏†‡∏π‡∏ä‡∏µ‡πâ‡∏ü‡πâ‡∏≤)" required>
                            <textarea id="location-description" rows="3" class="input-field" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." required></textarea>
                            
                            <!-- üõ†Ô∏è ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡πâ‡∏≠‡∏ô URL ‡πÅ‡∏ó‡∏ô Lat/Lng -->
                            <input type="url" id="location-url" class="input-field text-sm" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô https://maps.app.goo.gl/...)" required>

                            <button id="save-btn" type="submit" class="btn-admin w-full">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
                            </button>
                            <button type="button" id="cancel-btn" class="btn-update w-full hidden">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                        </div>
                    </form>
                    <div id="message-box" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
                </div>
            </div>

            <!-- Column 2 & 3: Attraction List -->
            <div class="lg:col-span-2">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
                    <div id="locations-list" class="space-y-3 max-h-[70vh] overflow-y-auto">
                        <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- JavaScript Section -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, setLogLevel, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ******************************************************
        // ‚ö†Ô∏è Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö index.html)
        // ******************************************************
        const FIREBASE_CONFIG = {
¬† ¬† ¬† ¬† ¬† ¬† apiKey: "AIzaSyB7bEabkGgF_mxmA-l9J6Lvd_3Au2qNX00",
¬† ¬† ¬† ¬† ¬† ¬† authDomain: "travel-roams.firebaseapp.com",
¬† ¬† ¬† ¬† ¬† ¬† projectId: "travel-roams",
¬† ¬† ¬† ¬† ¬† ¬† storageBucket: "travel-roams.firebasestorage.app",
¬† ¬† ¬† ¬† ¬† ¬† messagingSenderId: "745882789310",
¬† ¬† ¬† ¬† ¬† ¬† appId: "1:745882789310:web:dd01bc9121587efbaa45ef",
¬† ¬† ¬† ¬† ¬† ¬† measurementId: "G-FDB92BT0RJ"
¬† ¬† ¬† ¬† };
        const APP_ID = 'travel-map'; 

        setLogLevel('Debug');

        let app, db, auth; 
        let userId = 'loading';
        let editingId = null; 
        
        const urlInput = document.getElementById('location-url'); 
        const saveBtn = document.getElementById('save-btn');
        const cancelBtn = document.getElementById('cancel-btn'); 
        const nameInput = document.getElementById('location-name');
        const descInput = document.getElementById('location-description');
        const messageBox = document.getElementById('message-box');
        const userInfoDiv = document.getElementById('user-info');
        const locationsListDiv = document.getElementById('locations-list');
        const loginSection = document.getElementById('login-section');
        const adminContent = document.getElementById('admin-content');
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        const formTitle = document.getElementById('form-title');

        let isConfigValid = true;
        if (!FIREBASE_CONFIG.apiKey) {
            userInfoDiv.innerHTML = '<span class="text-red-600">‚ùå Config Error</span>';
            console.error("Firebase API Key is missing.");
            isConfigValid = false;
        }

        // üõ†Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏¢‡∏Å Lat/Lng ‡∏à‡∏≤‡∏Å Google Maps URL
        function parseLatLngFromUrl(url) {
            // Regex 1: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö @lat,lng,z (‡∏û‡∏ö‡πÉ‡∏ô URL ‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å Address Bar)
            const regex1 = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
            const match1 = url.match(regex1);
            if (match1 && match1.length >= 3) {
                return { lat: parseFloat(match1[1]), lng: parseFloat(match1[2]) };
            }
            
            // Regex 2: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö /data=!3dlat!4dlng (‡∏û‡∏ö‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå Share/Embed ‡∏ö‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)
            const regex2 = /!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/;
            const match2 = url.match(regex2);
            if (match2 && match2.length >= 3) {
                return { lat: parseFloat(match2[1]), lng: parseFloat(match2[2]) };
            }

            return null;
        }

        // üõ†Ô∏è ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UI ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        function setEditMode(isEditing) {
            if (isEditing) {
                formTitle.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà';
                saveBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà';
                saveBtn.classList.remove('btn-admin');
                saveBtn.classList.add('btn-update');
                cancelBtn.classList.remove('hidden');
            } else {
                formTitle.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà';
                saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà';
                saveBtn.classList.add('btn-admin');
                saveBtn.classList.remove('btn-update');
                cancelBtn.classList.add('hidden');
                editingId = null;
                // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                nameInput.value = '';
                descInput.value = '';
                urlInput.value = ''; 
            }
        }

        cancelBtn.addEventListener('click', () => setEditMode(false)); 

        function showAdminContent(isLoggedIn) {
            if (isLoggedIn) {
                loginSection.classList.add('hidden');
                adminContent.classList.remove('hidden');
                saveBtn.disabled = false;
            } else {
                adminContent.classList.add('hidden');
                loginSection.classList.remove('hidden');
                saveBtn.disabled = true;
            }
        }

        async function initializeFirebase() {
            if (!isConfigValid) return;

            try {
                app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);

                await signOut(auth).catch(() => {});

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfoDiv.innerHTML = `Admin ID: <span class="font-mono">${userId.substring(0, 8)}...</span> <button id="logout-btn" class="text-red-500 hover:text-red-700 ml-2 text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>`;
                        document.getElementById('logout-btn').addEventListener('click', () => {
                            signOut(auth);
                        });
                        showAdminContent(true);
                        listenForAttractions();
                    } else {
                        userId = null;
                        userInfoDiv.innerHTML = `‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö`;
                        showAdminContent(false);
                    }
                });

            } catch (error) {
                userInfoDiv.innerHTML = `‚ùå Firebase Error`;
                console.error(`Error initializing Firebase: ${error.message}`);
                showAdminContent(false);
            }
        }
        
        // --- Login Logic ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            
            loginMessage.classList.add('hidden');
            document.getElementById('login-btn').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            document.getElementById('login-btn').disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                let errorMessage = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                } else if (error.code === 'auth/configuration-not-found') {
                    errorMessage = '‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: Auth/Email-Password ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Firebase';
                } else {
                    errorMessage = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                }
                loginMessage.textContent = errorMessage;
                loginMessage.classList.remove('hidden');
            } finally {
                document.getElementById('login-btn').textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                document.getElementById('login-btn').disabled = false;
            }
        });
        // -------------------

        initializeFirebase();

        function showStatus(message, className) {
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-3 rounded-lg text-sm ${className}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => { messageBox.classList.add('hidden'); }, 7000);
        }

        // üõ†Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 
        window.startEdit = function(attractionId, name, description, lat, lng) {
            editingId = attractionId;
            nameInput.value = name;
            descInput.value = description;
            // üõ†Ô∏è ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            urlInput.value = `‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${lat},${lng}`; 
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
            setEditMode(true);
        }

        // üõ†Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
        window.deleteAttraction = async function(attractionId, name) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${name}?`)) return;

            try {
                const docPath = doc(db, `artifacts/${APP_ID}/public/data/attractions`, attractionId);
                await deleteDoc(docPath);
                showStatus(`üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'bg-red-200 text-red-800');
            } catch (error) {
                showStatus(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${error.message}. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firestore Rules (allow write) ‡∏î‡πâ‡∏ß‡∏¢`, 'bg-red-200 text-red-800');
            }
        }

        // üõ†Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å URL)
        window.saveAttraction = async function(event) {
            event.preventDefault();
            
            const name = nameInput.value.trim();
            const description = descInput.value.trim();
            const url = urlInput.value.trim(); 
            
            if (!name || !description || !url) {
                showStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", 'bg-yellow-200 text-yellow-800');
                return;
            }
            if (!userId) {
                showStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", 'bg-red-200 text-red-800');
                return;
            }

            let lat, lng;
            const coords = parseLatLngFromUrl(url);

            if (coords) {
                lat = coords.lat;
                lng = coords.lng;
            } else if (editingId && url.startsWith('‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:')) {
                // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå
                const existingCoords = url.replace('‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ', '').split(',');
                lat = parseFloat(existingCoords[0]);
                lng = parseFloat(existingCoords[1]);
            } else {
                // ‚ö†Ô∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
                showStatus("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡πà‡∏≤ Latitude/Longitude ‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤ (‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏•‡∏≠‡∏á‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å **URL ‡πÄ‡∏ï‡πá‡∏°** ‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå **'‡πÅ‡∏ä‡∏£‡πå'** ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô URL ‡∏¢‡∏≤‡∏ß)", 'bg-red-200 text-red-800');
                return;
            }


            saveBtn.disabled = true;
            saveBtn.textContent = (editingId ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            
            const data = {
                name, description, lat, lng, userId: userId, timestamp: serverTimestamp()
            };

            try {
                const collectionPath = `artifacts/${APP_ID}/public/data/attractions`;

                if (editingId) {
                    const docPath = doc(db, collectionPath, editingId);
                    await updateDoc(docPath, data); 
                    showStatus(`‚úèÔ∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`, 'bg-update-color text-white');
                } else {
                    await addDoc(collection(db, collectionPath), data);
                    showStatus(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`, 'bg-green-200 text-green-800');
                }

                setEditMode(false); 

            } catch (error) {
                showStatus(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: ${error.message}. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firestore Rules (allow write) ‡∏î‡πâ‡∏ß‡∏¢`, 'bg-red-200 text-red-800');
                saveBtn.disabled = false;
                saveBtn.textContent = (editingId ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà');
            }
        }

        function listenForAttractions() {
            if (!db || userId === 'loading') return;

            const collectionPath = `artifacts/${APP_ID}/public/data/attractions`;
            const q = collection(db, collectionPath);
            
            onSnapshot(q, (snapshot) => {
                locationsListDiv.innerHTML = '';

                if (snapshot.empty) {
                    locationsListDiv.innerHTML = '<p class="text-gray-500 p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>';
                }

                snapshot.docs.forEach(doc => {
                    const attraction = { id: doc.id, ...doc.data() };
                    const dateStr = attraction.timestamp ? new Date(attraction.timestamp.toMillis()).toLocaleString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-white border border-gray-200 rounded-lg space-y-2';
                    item.innerHTML = `
                        <h4 class="text-lg font-bold text-admin-dark">${attraction.name}</h4>
                        <p class="text-sm text-gray-600">${attraction.description}</p>
                        <small class="block text-xs text-gray-500">
                            ‡∏û‡∏¥‡∏Å‡∏±‡∏î: (${attraction.lat.toFixed(4)}, ${attraction.lng.toFixed(4)})
                        </small>
                        
                        <div class="flex space-x-2 mt-2 pt-2 border-t border-gray-100">
                            <button onclick="startEdit('${attraction.id}', '${attraction.name.replace(/'/g, "\\'")}', '${attraction.description.replace(/'/g, "\\'")}', ${attraction.lat}, ${attraction.lng})"
                                class="flex-1 bg-yellow-500 text-white text-xs py-1 rounded hover:bg-yellow-600 transition-colors">
                                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button onclick="deleteAttraction('${attraction.id}', '${attraction.name.replace(/'/g, "\\'")}')"
                                class="flex-1 bg-red-500 text-white text-xs py-1 rounded hover:bg-red-600 transition-colors">
                                ‡∏•‡∏ö
                            </button>
                        </div>
                        <small class="block text-xs text-gray-400 mt-1">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢: ${attraction.userId.substring(0, 8)}... ‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${dateStr}
                        </small>
                    `;
                    locationsListDiv.appendChild(item);
                });
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                locationsListDiv.innerHTML = '<p class="text-red-500 p-4">‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Security Rules (allow read) ‡∏î‡πâ‡∏ß‡∏¢</p>';
            });
        }
    </script>
</body>
</html>